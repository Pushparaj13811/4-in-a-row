name: Deploy Backend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          # Create deployment package
          tar -czf backend-deploy.tar.gz dist package.json package-lock.json

          # Copy to EC2
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            backend-deploy.tar.gz ${EC2_USER}@${EC2_HOST}:/tmp/

          # Deploy on EC2
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e

            # Create backend directory if it doesn't exist
            mkdir -p /home/ubuntu/GATI-mail-backend/test/4-in-a-row

            # Create systemd service if it doesn't exist
            if [ ! -f /etc/systemd/system/4-in-a-row-backend.service ]; then
              echo "Creating systemd service..."
              sudo tee /etc/systemd/system/4-in-a-row-backend.service > /dev/null <<'SYSTEMD'
              [Unit]
              Description=4 in a Row Backend WebSocket Server
              After=network.target

              [Service]
              Type=simple
              User=ubuntu
              WorkingDirectory=/home/ubuntu/GATI-mail-backend/test/4-in-a-row
              ExecStart=/usr/bin/node dist/index.js
              Restart=on-failure
              RestartSec=10
              StandardOutput=append:/var/log/4-in-a-row-backend.log
              StandardError=append:/var/log/4-in-a-row-backend-error.log
              Environment=NODE_ENV=production
              Environment=PORT=3008

              [Install]
              WantedBy=multi-user.target
              SYSTEMD

              sudo systemctl daemon-reload
              sudo systemctl enable 4-in-a-row-backend
            fi

            # Stop existing backend
            sudo systemctl stop 4-in-a-row-backend || true

            # Extract new build
            cd /home/ubuntu/GATI-mail-backend/test/4-in-a-row
            tar -xzf /tmp/backend-deploy.tar.gz

            # Install production dependencies
            npm ci --production

            # Start backend service
            sudo systemctl start 4-in-a-row-backend
            sudo systemctl status 4-in-a-row-backend --no-pager

            # Cleanup
            rm /tmp/backend-deploy.tar.gz
          EOF

          # Cleanup local key
          rm ec2_key.pem

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          sleep 5

          # Check if backend service is running
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            if sudo systemctl is-active --quiet 4-in-a-row-backend; then
              echo "✅ Backend service is running"
              sudo systemctl status 4-in-a-row-backend --no-pager | head -n 10
              exit 0
            else
              echo "❌ Backend service is not running"
              sudo journalctl -u 4-in-a-row-backend -n 20
              exit 1
            fi
          EOF

          rm ec2_key.pem
